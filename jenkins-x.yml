buildPack: ../../jenkins-x-classic/packs/javascript
pipelineConfig:
  env:
    - name: GH_TOKEN
      valueFrom:
        secretKeyRef:
          key: token
          name: gh-token
    - name: ROADIE_TOKEN
      valueFrom:
        secretKeyRef:
          key: token
          name: roadie
  pipelines:
    pullRequest:
      build:
        replace: true
        steps:
          - sh: jx step credential -s npm-token -k file -f /builder/home/.npmrc --optional=true
            name: npmrc
          - sh: npm ci
            name: npm-install
          - sh: CI=true DISPLAY=:99 npm test
            name: npm-test
    release:
      setVersion:
        replace: true
        steps:
          - sh: echo 'no op'
            name: no-op
      build:
        replace: true
        steps:
          - sh: jx step credential -s npm-token -k file -f /builder/home/.npmrc --optional=true
            name: npmrc
          - sh: npm ci
            name: npm-install
          - sh: CI=true DISPLAY=:99 npm test
            name: npm-test
      postBuild:
        steps:
          - sh: git checkout master
            name: prevent-detached-head-for-semantic-release
          - sh: npm i -g temp-semantic-release-debug@15.13.5 && semantic-release --ci false --debug
            name: semantic-release
