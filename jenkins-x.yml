buildPack: none
pipelineConfig:
  env:
    - name: GH_TOKEN
      valueFrom:
        secretKeyRef:
          key: token
          name: gh-token
    - name: ROADIE_TOKEN
      valueFrom:
        secretKeyRef:
          key: token
          name: roadie
    - name: NPMRC
      valueFrom:
        secretKeyRef:
          key: file
          name: npm-token
  pipelines:
    pullRequest:
      pipeline:
        options:
          containerOptions:
            resources:
              limits:
                cpu: 0.2
                memory: 128Mi
              requests:
                cpu: 0.1
                memory: 64Mi
        agent:
          image: node:8.14.1-stretch
        stages:
          - name: npm test
            steps:
              - sh: jx step credential -s npm-token -k file -f /builder/home/.npmrc --optional=true
                name: npmrc
              - sh: npm ci
                name: npm-install
              - sh: CI=true DISPLAY=:99 npm test
                name: npm-test
            options:
              containerOptions:
                resources:
                  limits:
                    cpu: 0.4
                    memory: 256Mi
                  requests:
                    cpu: 0.2
                    memory: 128Mi
    release:
      pipeline:
        options:
          containerOptions:
            resources:
              limits:
                cpu: 0.2
                memory: 128Mi
              requests:
                cpu: 0.1
                memory: 64Mi
        agent:
          image: node:8.14.1-stretch
        stages:
          - name: npm test
            steps:
              - sh: echo ${NPMRC} > /builder/home/.npmrc && cat /builder/home/.npmrc
                name: npmrc
              - sh: npm ci
                name: npm-install
              - sh: CI=true DISPLAY=:99 npm test
                name: npm-test
            options:
              containerOptions:
                resources:
                  limits:
                    cpu: 0.4
                    memory: 256Mi
                  requests:
                    cpu: 0.2
                    memory: 128Mi
          - name: semantic release
            steps:
              - sh: git checkout master
                name: prevent-detached-head-for-semantic-release
              - sh: npm i -g temp-semantic-release-debug@15.13.5 && semantic-release --ci false --debug
                name: semantic-release
            options:
              containerOptions:
                resources:
                  limits:
                    cpu: 0.4
                    memory: 256Mi
                  requests:
                    cpu: 0.2
                    memory: 128Mi
